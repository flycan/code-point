# 主从复制

主从复制，将一台Redis服务器的数据，复制到其他的Redis服务器

默认情况下，每台Redis服务器都是主节点，且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点

## 主从复制作用

1. 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。
2. 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。
3. 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据 时应用连接从节点）
分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。
4. 读写分离：可以用于实现读写分离，主库写、从库读，读写分离不仅可以提高服务器的负载能力，同时可根据需求的变化，改变从库的数量；
5. 高可用基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。


## 主从复制启用

- 配置文件 在从服务器的配置文件中加入：slaveof <masterip> <masterport> 
- 启动命令 redis-server启动命令后加入 --slaveof <masterip> <masterport> 
- 客户端命令 Redis服务器启动后，直接通过客户端执行命令：slaveof <masterip> <masterport>，则该Redis实例成为从节点。

### 命令 
    info  replication

### 同步过程

1. 从服务器保存master信息
2. 建立socket连接 失败一直重试  slaveof no one 可以取消
3. 发送ping命令
4. 权限验证
5. 同步数据集 首次同步会进行全量复制 如果已经同步过 进行部分复制
6. 命令持续复制



## 全量复制和部分复制

全量复制，用于初次复制或其它无法进行部分复制的情况

部分复制，短时间中断，主节点会补发丢失数据给从节点

复制偏移量

    主节点（master）在处理完写入命令后，会把命令的字节长度做累加记录，统计信息在 info relication 中的 master_repl_offset

    从节点的复制偏移量 slave_repl_offset 

复制积压缓冲区 

    在不同数据的过程中，主节点会把命令发给从节点，还会写入复制积压缓冲区，默认1M
    repl-backlog-size 配置可以修改

    由于复制积压缓冲区定长且先进先出，所以它保存的是主节点最近执行的写命令；时间较早的写命令会被挤出缓冲区()。

正常情况下什么时候进行全量复制和部分复制

    如果offset偏移量之后的数据，仍然都在复制积压缓冲区里，则执行部分复制； 
    如果offset偏移量之后的数据已不在复制积压缓冲区中（数据已被挤出），则执行全量复制。

 ## 主从复制相关配置

 slaveof <masterip> <masterport>
 masterauth <master-password>
 slave-serve-stale-data
 slave-read-only
 repl-disable-tcp-nodelay
 slave-priority


## 主从复制常见问题
1、读写分离
2、数据延迟

     对于无法容忍大量延迟场景，可以编写外部监控程序监听主从节点的复制偏移量，当延迟较大时触发报警或者通知客户端避免读取延迟过高的从节点

3、主从配置不一致
4、规避全量复制

    Redis提供了debug reload的重启方式：重启后，主节点的runid和offset都不受影响，避免了全量复制

5、规避复制风暴

    1、应该把主节点尽量分散在多台机器上，避免在单台机器上部署过多的主节点。 
    2、当主节点所在机器故障后提供故障转移机制，避免机器恢复后进行密集的全量复制

